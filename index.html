<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Coinbase Monitoring Dashboard</title>
  <style>
    *{box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:0;background:linear-gradient(135deg,#f8fffe 0%,#f1f8f6 100%);min-height:100vh;color:#1a1a1a}
    header{background:linear-gradient(135deg,#4a6741 0%,#5a7c50 100%);color:#fff;padding:24px 32px;box-shadow:0 4px 20px rgba(74,103,65,.15);position:relative;overflow:hidden}
    header::before{content:'';position:absolute;inset:0;background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>')}
    .header-content{position:relative;z-index:1}
    .header-title{margin:0;font-size:28px;font-weight:600;letter-spacing:-.02em}
    .header-subtitle{color:rgba(255,255,255,.8);font-size:14px;margin:4px 0 0 0;font-weight:400}
    
    /* Enhanced Summary Bar Styles */
    .summary-section {
      background: #fff;
      margin: 20px auto;
      max-width: 1200px;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,.08);
      border: 1px solid rgba(139,195,74,.2);
      overflow: hidden;
    }
    
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      background: transparent;
      padding: 20px;
    }
    
    .summary-item {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,.08);
      border: 1px solid rgba(139,195,74,.2);
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .summary-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0,0,0,.12);
      border-color: rgba(139,195,74,.4);
    }
    
    .summary-label {
      color: #333;
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }
    
    .summary-value {
      font-size: 32px;
      font-weight: 700;
      color: #4a6741;
      margin: 0;
    }

    .wrap{max-width:1200px;margin:0 auto;padding:32px 24px}
    .controls{display:flex;gap:8px;align-items:center;margin:18px 0 6px 0;flex-wrap:wrap}
    select,input{padding:10px 12px;border-radius:10px;border:1px solid #d9e1ec}
    .section-title{font-size:20px;font-weight:700;color:#1a1a1a;margin:18px 0 10px 0;display:flex;align-items:center;gap:12px}
    .section-title::before{content:'';width:4px;height:20px;background:linear-gradient(135deg,#8bc34a,#7cb342);border-radius:2px}
    .articles-container{display:grid;gap:20px}
    .card{background:#fff;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,.08);padding:0;border:1px solid rgba(139,195,74,.2);transition:.3s;position:relative;overflow:hidden;opacity:0;transform:translateY(20px);animation:slideIn .5s ease forwards}
    @keyframes slideIn{to{opacity:1;transform:translateY(0)}}
    .card::before{content:'';position:absolute;top:0;left:0;width:100%;height:4px;background:linear-gradient(90deg,#8bc34a,#7cb342)}
    .card:hover{transform:translateY(-3px);box-shadow:0 12px 40px rgba(0,0,0,.15);border-color:rgba(139,195,74,.4)}
    .card-content{padding:24px}
    .card-title{font-size:18px;font-weight:600;color:#1a1a1a;margin:0 0 12px 0;line-height:1.4}
    .card-title a{color:inherit;text-decoration:none;transition:.3s}
    .card-title a:hover{color:#4a6741}
    .meta{color:#666;font-size:14px;margin-bottom:16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .chip{background:linear-gradient(135deg,rgba(139,195,74,.15),rgba(139,195,74,.25));border:1px solid rgba(139,195,74,.3);border-radius:12px;padding:6px 12px;margin:4px 6px 4px 0;font-size:12px;font-weight:500;display:inline-block;color:#4a6741;transition:.3s}
    .chip:hover{background:linear-gradient(135deg,rgba(139,195,74,.25),rgba(139,195,74,.35));transform:scale(1.05)}
    .chip-container{margin-top:16px;padding-top:16px;border-top:1px solid rgba(139,195,74,.2)}

    .loading{display:flex;align-items:center;justify-content:center;padding:40px;color:#666}
    .loading::before{content:'';width:20px;height:20px;border:2px solid rgba(139,195,74,.3);border-top:2px solid #8bc34a;border-radius:50%;animation:spin 1s linear infinite;margin-right:12px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    #err{background:linear-gradient(135deg,#ffebee,#fce4ec);border:1px solid #ffcdd2;color:#d32f2f;padding:16px 20px;border-radius:12px;margin:16px 0;font-weight:500;display:none}
    .empty-state{text-align:center;padding:60px 20px;color:#666;background:#fff;border-radius:16px;border:1px solid rgba(139,195,74,.2)}
    .empty-state-icon{font-size:48px;margin-bottom:16px;opacity:.5}
    .refresh-btn{background:linear-gradient(135deg,#8bc34a,#7cb342);color:#fff;border:none;padding:12px 24px;border-radius:12px;font-weight:600;cursor:pointer;transition:.3s;margin-top:16px}
    .refresh-btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(139,195,74,.3)}
    .card-loading{background:#fff;border-radius:16px;padding:24px;margin:16px 0;border:1px solid rgba(139,195,74,.2);animation:pulse 1.5s ease-in-out infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
    .skeleton{background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:loading 1.5s infinite;border-radius:4px}
    @keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .skeleton-title{height:20px;margin-bottom:12px;width:75%}
    .skeleton-meta{height:14px;margin-bottom:8px;width:40%}
    .skeleton-chip{height:24px;width:60px;display:inline-block;margin-right:8px}
    @media (max-width:768px){
      .wrap{padding:20px 16px}
      .summary-grid{grid-template-columns:repeat(2, 1fr)}
      .meta{flex-direction:column;align-items:flex-start;gap:8px}
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1 class="header-title">Coinbase Monitoring Dashboard</h1>
      <p class="header-subtitle">Real-time cryptocurrency mention tracking</p>
    </div>
  </header>

  <!-- Enhanced Summary Bar -->
  <div class="summary-section">
    <div class="summary-grid">
      <div class="summary-item">
        <div class="summary-label">Last 24 Hours</div>
        <div class="summary-value" id="sb-last24">—</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">Total</div>
        <div class="summary-value" id="sb-total">—</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">Active Sources</div>
        <div class="summary-value" id="sb-sources">—</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">Meltwater</div>
        <div class="summary-value" id="sb-mw">—</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">Google Alerts</div>
        <div class="summary-value" id="sb-google">—</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">RSS Feeds</div>
        <div class="summary-value" id="sb-rss">—</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">Twitter/X</div>
        <div class="summary-value" id="sb-x">—</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">Reddit</div>
        <div class="summary-value" id="sb-reddit">—</div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="controls">
      <label for="section">Section</label>
      <select id="section">
        <option value="">All</option>
        <option>Top Crypto News</option>
        <option>Major Sources</option>
        <option>Aggregators</option>
        <option>Specialized</option>
        <option>Other</option>
      </select>
      <label for="search">Search</label>
      <input id="search" placeholder="Filter title…"/>
    </div>

    <div id="err"></div>
    <h2 class="section-title">Recent Mentions</h2>
    <div id="loading" class="loading" style="display:none">Loading mentions...</div>

    <div id="list" class="articles-container"></div>
  </div>

  <script>
    let loadingSkeletons = [];

    function createLoadingSkeleton(){
      const div=document.createElement('div');
      div.className='card-loading';
      div.innerHTML=`
        <div class="skeleton skeleton-title"></div>
        <div class="skeleton skeleton-meta"></div>
        <div class="skeleton skeleton-meta" style="width:30%"></div>
        <div style="margin-top:16px">
          <div class="skeleton skeleton-chip"></div>
          <div class="skeleton skeleton-chip"></div>
          <div class="skeleton skeleton-chip"></div>
        </div>`;
      return div;
    }
    function showLoadingSkeletons(count=5){
      const list=document.getElementById('list');
      list.innerHTML=''; loadingSkeletons=[];
      for (let i=0;i<count;i++){
        const s=createLoadingSkeleton(); s.style.animationDelay=`${i*0.1}s`;
        list.appendChild(s); loadingSkeletons.push(s);
      }
    }
    function removeLoadingSkeletons(){
      loadingSkeletons.forEach(s=>s.parentNode&&s.parentNode.removeChild(s));
      loadingSkeletons=[];
    }

    function updateStats(data){
      // This function is kept for compatibility but stats are now handled in the summary section
    }

    function formatDate(s){
      const d=new Date(s);
      return d.toLocaleString('en-US',{year:'numeric',month:'numeric',day:'numeric',hour:'numeric',minute:'2-digit',hour12:true});
    }

    function addArticleCard(container, article, delay=0){
      return new Promise(resolve=>{
        setTimeout(()=>{
          const div=document.createElement('div');
          div.className='card';
          div.style.animationDelay=`${delay}s`;
          const chips=(article.matched||[]).map(k=>`<span class="chip">${k}</span>`).join('');
          div.innerHTML=`
            <div class="card-content">
              <h3 class="card-title"><a href="${article.link}" target="_blank" rel="noopener">${article.title}</a></h3>
              <div class="meta">
                <div>${article.source} · ${formatDate(article.published)}</div>
              </div>
              ${chips?`<div class="chip-container">${chips}</div>`:''}
            </div>`;
          container.appendChild(div);
          resolve();
        }, delay*100);
      });
    }

    function groupBySection(items){
      const order=["Top Crypto News","Major Sources","Aggregators","Specialized","Other"];
      const map=new Map(order.map(s=>[s,[]]));
      for (const m of items){
        const sec = m.section || "Other";
        if (!map.has(sec)) map.set(sec, []);
        map.get(sec).push(m);
      }
      return { order, map };
    }

    async function loadMentions(){
      try{
        document.getElementById('err').style.display='none';
        showLoadingSkeletons(5);

        const section=document.getElementById('section').value;
        const search=(document.getElementById('search').value||'').trim().toLowerCase();

        const qs=new URLSearchParams();
        qs.set('limit','300');
        if (section) qs.set('section', section);

        const r=await fetch('/api/get_mentions?'+qs.toString());
        if (!r.ok) throw new Error('HTTP '+r.status);
        const data=await r.json();

        // text filter
        const filtered = search ? data.filter(m => (m.title||"").toLowerCase().includes(search)) : data;

        // Sort by date/time - newest first
        filtered.sort((a, b) => new Date(b.published) - new Date(a.published));

        updateStats(filtered);
        removeLoadingSkeletons();

        const list=document.getElementById('list');
        list.innerHTML='';

        if (!filtered.length){
          list.innerHTML=`
            <div class="empty-state">
              <div class="empty-state-icon">📊</div>
              <h3>No mentions for this view</h3>
              <p>Try another section or refresh the data.</p>
              <button class="refresh-btn" onclick="loadMentions()">Refresh Data</button>
            </div>`;
          return;
        }

        // Group by section and render each group with a header
        const { order, map } = groupBySection(filtered);
        let sectionCount = 0;
        for (const sec of order){
          const items = map.get(sec) || [];
          if (!items.length) continue;
          sectionCount++;

          const h = document.createElement('h3');
          h.className='section-title';
          h.textContent = sec;
          list.appendChild(h);

          for (let i=0;i<items.length;i++){
            await addArticleCard(list, items[i], i*0.05);
          }
        }

        // If a custom/unknown section exists, render it at the end
        for (const [sec, items] of map){
          if (order.includes(sec)) continue;
          if (!items.length) continue;
          const h=document.createElement('h3'); h.className='section-title'; h.textContent=sec;
          list.appendChild(h);
          for (let i=0;i<items.length;i++){
            await addArticleCard(list, items[i], i*0.05);
          }
        }

      }catch(e){
        removeLoadingSkeletons();
        const el=document.getElementById('err'); el.style.display='block';
        el.textContent='Could not load mentions. '+e.message;
        console.error('Error loading mentions:', e);
      }
    }

    document.getElementById('section').addEventListener('change', loadMentions);
    document.getElementById('search').addEventListener('input', ()=>{
      clearTimeout(window._t); window._t=setTimeout(loadMentions,250);
    });

    loadMentions();
    setInterval(loadMentions, 5*60*1000);
  </script>
  
  <script>
(async function(){
  try{
    const res = await fetch('/api/summary?window=24h', { cache: 'no-store' });
    const data = await res.json();
    if (!data?.ok) return;

    const fmt = (n) => (typeof n === 'number' && Number.isFinite(n) && n.toLocaleString) ? n.toLocaleString() : (n ?? '0');
    const by = (data.totals && data.totals.by_origin) ? data.totals.by_origin : {};

    const setText = (id, val) => {
      const el = document.getElementById(id);
      if (el) el.textContent = fmt(val);
    };

    setText('sb-last24', data.totals?.all);
    setText('sb-total', data.totals?.all);
    setText('sb-sources', Object.keys(by).length || 0);
    setText('sb-mw',    by.meltwater);
    setText('sb-google', by.google_alerts || by.google || 0);
    setText('sb-rss',   by.rss);
    setText('sb-x',     by.x);
    setText('sb-reddit',by.reddit);
  } catch(e) {
    console.error('Error loading summary:', e);
  }
})();
</script>

</body>
</html>
