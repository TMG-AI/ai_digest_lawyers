<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>MW Webhook Tester</title>
  <style>
    body{font-family:system-ui,Arial;margin:24px;max-width:820px}
    textarea,input,button{font-size:14px}
    textarea{width:100%;height:220px}
    .row{margin:10px 0}
    .ok{color:#1b5e20}
    .bad{color:#b71c1c}
    pre{white-space:pre-wrap;background:#f7f7f7;padding:10px;border-radius:8px;border:1px solid #eee}
  </style>
</head>
<body>
  <h2>Meltwater → /api/meltwater_webhook tester</h2>

  <div class="row">
    <label>Secret (?key=…): <input id="sec" placeholder="YOUR_SECRET" style="width:260px"/></label>
    <label style="margin-left:12px">Force (skip dedupe): <input id="force" type="checkbox"/></label>
  </div>

  <div class="row">
    <div>Payload (single object OK):</div>
    <textarea id="payload"></textarea>
  </div>

  <div class="row">
    <button id="send">Send</button>
  </div>

  <div id="out"></div>

<script>
const sample = {
  id: "mw_demo_" + Math.floor(Math.random()*1e6),
  type: "Every Mention",
  providerType: "news",
  title: "Test Coinbase mention " + Date.now(),
  statusLine: "12.4K Reach — Positive",
  source: "Coinbase News alerts",
  authorName: "CoinMarketCap",
  text: "Sample body text",
  links: {
    article: "https://coinmarketcap.com/community/articles/demo-" + Math.floor(Math.random()*1e6),
    source: "https://coinmarketcap.com/"
  },
  published_at: new Date().toISOString()
};
document.getElementById('payload').value = JSON.stringify(sample, null, 2);

document.getElementById('send').onclick = async () => {
  const sec = document.getElementById('sec').value.trim();
  const force = document.getElementById('force').checked ? "&force=1" : "";
  const out = document.getElementById('out');
  out.innerHTML = "Sending…";

  try{
    const res = await fetch(`/api/meltwater_webhook?key=${encodeURIComponent(sec)}${force}&dbg=1`, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: document.getElementById('payload').value
    });
    const json = await res.json().catch(()=>({status:res.status}));
    out.innerHTML = `<div class="${res.ok?"ok":"bad"}">HTTP ${res.status}</div><pre>${JSON.stringify(json,null,2)}</pre>`;
  }catch(e){
    out.innerHTML = `<div class="bad">${e.message}</div>`;
  }
};
</script>
</body>
</html>
